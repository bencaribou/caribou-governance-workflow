<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Governance Workflow Diagram</title>

  <style>
    :root{
      --bg:#0b0b10;
      --panel:#12121a;
      --text:#f2f2f7;
      --muted:#b8b8c7;
      --border:rgba(255,255,255,.12);
      --shadow:0 12px 40px rgba(0,0,0,.45);
      --radius:14px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }

    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:var(--sans); }

    .wrap{
      height:100%;
      display:grid;
      grid-template-columns:1fr 360px;
      gap:12px;
      padding:12px;
      box-sizing:border-box;
    }

    .stage{
      position:relative;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
      min-height:520px;
    }

    .toolbar{
      position:absolute;
      top:10px; left:10px;
      display:flex; gap:8px;
      z-index:3;
    }

    .btn{
      background:rgba(255,255,255,.08);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ background:rgba(255,255,255,.12); }

    .hint{
      position:absolute;
      bottom:10px; left:10px;
      font-size:12px;
      color:var(--muted);
      z-index:3;
      background:rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      backdrop-filter:blur(6px);
    }

    .error{
      position:absolute;
      top:56px; left:10px; right:10px;
      z-index:4;
      padding:10px 12px;
      border:1px solid rgba(255,80,80,.35);
      background:rgba(255,80,80,.10);
      border-radius:12px;
      font-size:12px;
      display:none;
      white-space:pre-wrap;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      overflow:auto;
      min-height:520px;
    }

    .panel h2{ margin:0 0 6px 0; font-size:16px; }
    .panel .sub{ color:var(--muted); font-size:12px; margin-bottom:12px; line-height:1.35; }

    .card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:rgba(255,255,255,.03);
    }

    .label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
      margin-bottom:6px;
    }

    .value{ font-size:13px; line-height:1.4; }

    .mini{
      margin-top:10px;
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      white-space:pre-wrap;
      border-top:1px dashed var(--border);
      padding-top:10px;
    }

    #diagramWrap{ width:100%; height:100%; }
    #diagramWrap svg{ width:100%; height:100%; }

    /* Make nodes feel clickable */
    #diagramWrap svg g.node { cursor:pointer; }

    /* Preserve newlines for Mermaid input */
    pre.mermaid{ margin:0; padding:0; white-space:pre; }

    @media (max-width:900px){
      .wrap{ grid-template-columns:1fr; }
      .panel{ min-height:260px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="stage">
      <div class="toolbar">
        <button class="btn" id="zoomIn" type="button">Zoom +</button>
        <button class="btn" id="zoomOut" type="button">Zoom −</button>
        <button class="btn" id="reset" type="button">Reset</button>
      </div>

      <div class="hint">Tip: Scroll/trackpad to zoom • Click any node for details</div>
      <div class="error" id="errBox"></div>

      <div id="diagramWrap">
        <pre class="mermaid" id="diagram">
flowchart TD

A["Trigger: new project, new vendor, material change, incident"] --> B["Data screening intake"]

B --> C{"Personal data involved?"}

C -->|No| D["Record rationale and proceed with standard controls"]
C -->|Yes| E["Assign accountable role owner"]

E --> F{"High risk likely - DPIA screening"}

F -->|No| G["Update RoPA and apply baseline controls"]
F -->|Yes| H["Conduct DPIA"]

H --> I["DPO provides advice and review"]

I --> J{"Data Committee decision"}

J -->|Approve| K["Implement controls, notices and contracts"]
J -->|Approve with conditions| L["Implement and verify conditions"]
J -->|Pause redesign| M["Redesign processing and re-screen"]
J -->|Escalate| N["SLT decision and resource allocation"]

K --> O["Monitor, audit, train and communicate"]
L --> O
M --> F
N --> O

O --> P["Quarterly metrics and risk reporting to SLT"]

%% Styling
classDef decision fill:#1b1b26,stroke:#8b8bb8,color:#f2f2f7,stroke-width:1px;
classDef step fill:#14141f,stroke:#6d6d97,color:#f2f2f7,stroke-width:1px;
class C,F,J decision;
class A,B,D,E,G,H,I,K,L,M,N,O,P step;
        </pre>
      </div>
    </div>

    <aside class="panel">
      <h2>Governance workflow</h2>
      <div class="sub">Click any node to see what it means, what gets produced, and who typically leads it.</div>

      <div class="card">
        <div class="label">Selected step</div>
        <div class="value" id="selTitle">None selected</div>

        <div style="height:10px"></div>

        <div class="label">Purpose</div>
        <div class="value" id="selPurpose">—</div>

        <div style="height:10px"></div>

        <div class="label">Primary owner</div>
        <div class="value" id="selOwner">—</div>

        <div style="height:10px"></div>

        <div class="label">Outputs</div>
        <div class="value" id="selOutputs">—</div>

        <div class="mini" id="selMini"></div>
      </div>
    </aside>
  </div>

  <script>
    /**********************
     * Node details
     **********************/
    const NODE_INFO = {
      A:{title:"A — Trigger",purpose:"Start the governance workflow when something changes or risk emerges.",owner:"Chief of Staff + Requesting lead",outputs:"Logged trigger; intake created.",mini:"Examples: new client project, new vendor/tool, material change, incident."},
      B:{title:"B — Data screening intake",purpose:"Capture minimum required info to route the request correctly.",owner:"Chief of Staff + DPO",outputs:"Completed intake; initial classification.",mini:"Who/what/why/where/retention; link to project/vendor request."},
      C:{title:"C — Personal data involved?",purpose:"Decide whether GDPR/people-data controls apply.",owner:"DPO",outputs:"Decision (Yes/No) recorded with rationale.",mini:"If uncertain, treat as personal data until clarified."},
      D:{title:"D — Standard controls",purpose:"Proceed with baseline controls and keep an audit trail.",owner:"IT Lead + CKO",outputs:"Rationale note; baseline security controls applied.",mini:"Least privilege, secure storage, access control."},
      E:{title:"E — Assign accountable owner",purpose:"Name a single accountable owner for the processing activity.",owner:"Chief of Staff",outputs:"Owner recorded; delivery team confirmed.",mini:"Usually the project lead or functional owner (HR/BD/M&E)."},
      F:{title:"F — High risk likely - DPIA screening",purpose:"Determine whether a DPIA is required/recommended.",owner:"DPO + IT Lead",outputs:"DPIA screening result logged.",mini:"Triggers: special category data, vulnerable groups, new tech, large scale, cross-border transfers."},
      G:{title:"G — Update RoPA and proceed",purpose:"Record the activity and apply baseline protections.",owner:"DPO + IT Lead + Owner",outputs:"RoPA updated; baseline controls checklist completed.",mini:"Lawful basis, retention, access, vendor terms, notices."},
      H:{title:"H — Conduct DPIA",purpose:"Assess privacy risks and define mitigations before proceeding.",owner:"DPO + Owner",outputs:"Completed DPIA with mitigations and residual risk.",mini:"Purpose, necessity/proportionality, risks, mitigations, consultation."},
      I:{title:"I — DPO provides advice and review",purpose:"Independent advice and review.",owner:"DPO",outputs:"Documented advice and required mitigations.",mini:"Consult early; maintain independence."},
      J:{title:"J — Data Committee decision",purpose:"Approve, approve with conditions, pause/redesign, or escalate.",owner:"Data Committee (Chair: Chief of Staff)",outputs:"Decision record; action list; owners and timeline.",mini:"Minutes + rationale + follow-up tracking."},
      K:{title:"K — Implement controls",purpose:"Put technical/operational/legal controls in place.",owner:"IT Lead + DPO + Owner",outputs:"DPAs/SCCs, notices, access controls, SOPs.",mini:"Least privilege, encryption, audit logs, retention controls."},
      L:{title:"L — Implement and verify conditions",purpose:"Meet approval conditions and verify before go-live.",owner:"Chief of Staff + IT/DPO",outputs:"Condition checklist completed; evidence stored.",mini:"Examples: vendor security review, SCCs signed, DPIA mitigations implemented."},
      M:{title:"M — Redesign and re-screen",purpose:"Change approach to reduce risk, then re-screen.",owner:"Owner + IT Lead + DPO",outputs:"Revised design; updated screening/DPIA.",mini:"Reduce fields, anonymise/pseudonymise, change hosting region, shorten retention."},
      N:{title:"N — SLT decision and resource allocation",purpose:"Escalate high residual risk/material trade-offs for leadership decision.",owner:"SLT sponsor + Chief of Staff",outputs:"SLT decision; resource allocation; risk acceptance if applicable.",mini:"Use when mitigation cost/timeline/impact is significant."},
      O:{title:"O — Monitor and maintain",purpose:"Ongoing monitoring, audits, training and client comms as needed.",owner:"IT + HR + CKO + DPO",outputs:"Audit logs, training refresh, policy updates, comms packs.",mini:"Build checks into renewals and project close-out."},
      P:{title:"P — Quarterly reporting",purpose:"Report metrics and risk posture to SLT.",owner:"Chief of Staff + DPO",outputs:"Quarterly dashboard: RoPA, DPIAs, incidents, vendors, training.",mini:"Use to prioritise roadmap and resourcing."}
    };

    function showNode(id){
      const info = NODE_INFO[id] || {title:id,purpose:"—",owner:"—",outputs:"—",mini:""};
      document.getElementById("selTitle").textContent = info.title;
      document.getElementById("selPurpose").textContent = info.purpose;
      document.getElementById("selOwner").textContent = info.owner;
      document.getElementById("selOutputs").textContent = info.outputs;
      document.getElementById("selMini").textContent = info.mini || "";
    }

    function showError(msg){
      const box = document.getElementById("errBox");
      box.style.display = "block";
      box.textContent = msg;
    }

    /**********************
     * Load scripts with fallback
     **********************/
    function loadScript(src, fallback){
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => {
          const f = document.createElement("script");
          f.src = fallback;
          f.async = true;
          f.onload = () => resolve();
          f.onerror = () => reject(new Error("Failed to load: " + src + " and fallback: " + fallback));
          document.head.appendChild(f);
        };
        document.head.appendChild(s);
      });
    }

    /**********************
     * Robust click mapping: tag nodes once after render
     **********************/
    function tagSvgNodesWithKeys(svg) {
      const validKeys = new Set(Object.keys(NODE_INFO));
      const nodes = Array.from(svg.querySelectorAll("g.node"));

      nodes.forEach((g) => {
        const titleEl = g.querySelector("title");
        const title = titleEl ? titleEl.textContent.trim() : "";

        const dataId = (g.getAttribute("data-id") || "").trim();

        const rawId = (g.getAttribute("id") || "").trim();
        const idMatch = rawId.match(/flowchart-([A-Za-z0-9_]+)-/);

        const firstText = (g.querySelector("text")?.textContent || "").trim();

        const candidates = [
          dataId,
          title,
          idMatch ? idMatch[1] : "",
          firstText
        ].map(s => (s || "").trim());

        let key = candidates.find(c => validKeys.has(c));

        if (!key && title) {
          const tok = title.split(/\\s|—|-/)[0].trim();
          if (validKeys.has(tok)) key = tok;
        }

        if (!key && idMatch && idMatch[1]) {
          const tok = idMatch[1].charAt(0);
          if (validKeys.has(tok)) key = tok;
        }

        if (key) g.dataset.nodekey = key;
      });
    }

    function attachUniversalNodeClick(svg) {
      tagSvgNodesWithKeys(svg);

      svg.addEventListener("click", (evt) => {
        const nodeGroup = evt.target.closest("g.node");
        if (!nodeGroup) return;

        const key = nodeGroup.dataset.nodekey;
        if (key && NODE_INFO[key]) showNode(key);
      });
    }

    async function init(){
      try{
        await loadScript(
          "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js",
          "https://unpkg.com/mermaid@10/dist/mermaid.min.js"
        );
        await loadScript(
          "https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js",
          "https://unpkg.com/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"
        );

        mermaid.initialize({ startOnLoad:false, securityLevel:"loose", theme:"dark" });
        await mermaid.run({ querySelector: ".mermaid" });

        const svg = document.querySelector("#diagramWrap svg");
        if(!svg){
          showError(
            "Mermaid did not produce an SVG.\n\n" +
            "Common causes:\n" +
            "• Viewing a non-executing preview (GitHub blob / Notion code block)\n" +
            "• CDN blocked by your network\n\n" +
            "Use GitHub Pages URL (username.github.io/repo/) and /embed that in Notion."
          );
          return;
        }

        const panZoom = svgPanZoom(svg, {
          zoomEnabled:true,
          controlIconsEnabled:false,
          fit:true,
          center:true,
          minZoom:0.3,
          maxZoom:6
        });

        document.getElementById("zoomIn").addEventListener("click", ()=>panZoom.zoomBy(1.2));
        document.getElementById("zoomOut").addEventListener("click", ()=>panZoom.zoomBy(0.8));
        document.getElementById("reset").addEventListener("click", ()=>{ panZoom.resetZoom(); panZoom.center(); panZoom.fit(); });

        attachUniversalNodeClick(svg);
        showNode("A");
      }catch(e){
        showError("Failed to initialize diagram.\n\nError:\n" + (e && e.message ? e.message : String(e)));
      }
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
